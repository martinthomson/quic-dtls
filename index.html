<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Porting QUIC to Datagram Transport Layer Security (DTLS)</title>

  <style type="text/css">/*<![CDATA[*/
@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}

@media screen and (min-width: 1024px) {
  ul.toc, #rfc\.toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 500px);
    width: 300px;
    padding: 0 1em;
    z-index: 1;
  }
  #rfc\.toc {
    top: 16px;
  }
  ul.toc {
    top: 80px;
    overflow: auto;
  }

  body {
    padding-left: 1.5em;
    padding-right: 29em;
  }
}

body {
  font: 15px "Helvetica Neue",Helvetica,Arial,sans-serif;
  color: #333;
  font-size-adjust: 0.5;
  line-height: 130%;
  margin: 2.5em auto;
  max-width: 724px;
}

.title, .filename, h1, h2, h3, h4 {
  font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size-adjust: 0.5;
  font-weight: 500;
  color: #333;
  line-height: 100%;
  margin: 0.8em 0 0.3em;
}
.title { font-size: 36px; }
h1 { font-size: 30px; }
h2 { font-size: 24px; }
h3, h4 { font-size: 18px; }
h1 a[href], h2 a[href], h3 a[href], h4 a[href] {
  color: #333;
}

ul.toc li {
  list-style: none;
  text-indent: -2.5em;
  padding-left: 2.5em;
  padding-bottom: 5px;
  margin: 0;
}
ul.toc, ul.toc ul {
  margin: 0 0 0 1.5em;
}

table {
  margin-left: 0em;
  border-collapse: collapse;
}
th {
  text-align: left;
  border-bottom: 2px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
  vertical-align: top;
}
tr:nth-child(2n+1) > td,
tr:nth-child(2n+1) > th {
  background-color: #f9f9f9;
}
td.reference {
  max-width: 200px;
  border-top: none;
  padding-right: 1em;
}
.right {
  text-align: right;
}


table.header {
  width: 100%;
}
table.header td {
  border: none;
  background-color: transparent;
  color: black;
}
.filename {
  color: rgb(119, 119, 119);
  font-size: 23px;
  font-weight: normal;
  height: auto;
  line-height: 100%;
}
#rfc\.abstract+p {
  font-size: 20px;
  font-weight: 300;
  line-height: 130%;
}

samp, tt, code, pre {
  font: 11pt consolas, monospace;
  font-size-adjust: none;
}
pre {
  background-color: #eee;
  border: 1px solid #ddd;
  overflow-x: auto;
  padding: 5px;
  margin: 5px;
}
.figure {
  font-style: italic;
  margin: 0 1.5em;
}

address {
  margin: 10px 0 0;
}
.vcard {
  font-style: normal;
}
.vcardline {
  display: block;
}
.vcardline .fn {
  font-weight: bold;
}
.vcardline .hidden {
  display: none;
}

dl {
  margin-left: 1em;
}
dl.dl-horizontal: {
  margin-left: 0;
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl.nohang > dt {
  float: none;
}
dl > dd {
  margin-bottom: .5em;
}
dl.compact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
ul.empty {
  list-style-type: none;
}
ul.empty li {
  margin-top: .5em;
}

hr {
  border: 0;
  border-top: 1px solid #eee;
}

a {
  text-decoration: none;
}
a[href] {
  color: #2a6496;
}
a[href]:hover {
  background-color: #eee;
}

ol, ul, li, p {
  padding: 0;
  margin: 0.5em 0 0.5em 2em;
}
li, p {
  margin-left: 0;
}

.github-fork-ribbon-wrapper {
  display: none;
}
@media screen and (min-width: 800px) {
  /* "Fork me on GitHub" CSS ribbon based on
   * https://github.com/simonwhitaker/github-fork-ribbon-css
   */
  .github-fork-ribbon {
    position: absolute;
    padding: 2px 0;
    background-color: #a00;
    background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));
    box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);
    font: 700 12px "Helvetica Neue", Helvetica, Arial, sans-serif;

    pointer-events: auto;

    top: 38px;
    right: -45px;

    transform: rotate(45deg);
  }

  .github-fork-ribbon a[href],
  .github-fork-ribbon a[href]:hover {
    color: #fff;
    background-color: transparent;
    text-decoration: none;
    text-shadow: 0 -1px rgba(0, 0, 0, 0.5);
    text-align: center;

    width: 190px;
    line-height: 18px;

    display: inline-block;
    padding: 2px 0;

    border: 1.5px dotted #fff;
    border-color: rgba(255, 255, 255, 0.6);
  }

  .github-fork-ribbon-wrapper {
    display: block;
    width: 130px;
    height: 130px;
    position: absolute;
    overflow: hidden;
    top: 0; right: 0;
    z-index: 2;
    pointer-events: none;
  }
}
@media screen and (min-width: 1000px) {
  .github-fork-ribbon-wrapper {
    position: fixed;
  }
  /*]]>*/</style>

  <link href="#rfc.toc" rel="Contents"/>
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction"/>
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Notational Conventions"/>
<link href="#rfc.section.2" rel="Chapter" title="2 Protocol Overview"/>
<link href="#rfc.section.2.1" rel="Chapter" title="2.1 Handshake Overview"/>
<link href="#rfc.section.3" rel="Chapter" title="3 QUIC over DTLS Structure"/>
<link href="#rfc.section.4" rel="Chapter" title="4 Mapping of QUIC to QUIC over DTLS"/>
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Handshake Additions"/>
<link href="#rfc.section.4.1.1" rel="Chapter" title="4.1.1 Source Address Validation"/>
<link href="#rfc.section.4.1.2" rel="Chapter" title="4.1.2 Transport Parameter Advertisement"/>
<link href="#rfc.section.4.1.3" rel="Chapter" title="4.1.3 Congestion Management Before Handshake Completion"/>
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 Record Protection"/>
<link href="#rfc.section.4.3" rel="Chapter" title="4.3 Protocol and Version Negotiation"/>
<link href="#rfc.section.4.4" rel="Chapter" title="4.4 Connection ID"/>
<link href="#rfc.section.4.5" rel="Chapter" title="4.5 Entropy Bit"/>
<link href="#rfc.section.4.6" rel="Chapter" title="4.6 Forward Error Control (FEC)"/>
<link href="#rfc.section.4.7" rel="Chapter" title="4.7 Sequence Numbers"/>
<link href="#rfc.section.5" rel="Chapter" title="5 Modifications to DTLS"/>
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Handshake Message Loss Recovery"/>
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 DTLS Datagram Header"/>
<link href="#rfc.section.6" rel="Chapter" title="6 Security Considerations"/>
<link href="#rfc.section.7" rel="Chapter" title="7 IANA Considerations"/>
<link href="#rfc.references" rel="Chapter" title="8 References"/>
<link href="#rfc.references.1" rel="Chapter" title="8.1 Normative References"/>
<link href="#rfc.references.2" rel="Chapter" title="8.2 Informative References"/>
<link href="#rfc.authors" rel="Chapter"/>


  <meta name="generator" content="xml2rfc version 2.5.1 - http://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="Thomson, M." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-thomson-quic-dtls-latest" />
  <meta name="dct.issued" scheme="ISO8601" content="2016-1-21" />
  <meta name="dct.abstract" content="The QUIC experiment defines a custom security protocol.  This was necessary to gain handshake latency improvements.  This document describes how that security protocol might be replaced with DTLS." />
  <meta name="description" content="The QUIC experiment defines a custom security protocol.  This was necessary to gain handshake latency improvements.  This document describes how that security protocol might be replaced with DTLS." />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
  <td class="left">Network Working Group</td>
  <td class="right">M. Thomson</td>
</tr>
<tr>
  <td class="left">Internet-Draft</td>
  <td class="right">Mozilla</td>
</tr>
<tr>
  <td class="left">Intended status: Standards Track</td>
  <td class="right">January 21, 2016</td>
</tr>
<tr>
  <td class="left">Expires: July 24, 2016</td>
  <td class="right"></td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Porting QUIC to Datagram Transport Layer Security (DTLS)<br />
  <span class="filename">draft-thomson-quic-dtls-latest</span></p>
  
  <h1 id="rfc.abstract">
  <a href="#rfc.abstract">Abstract</a>
</h1>
<p>The QUIC experiment defines a custom security protocol.  This was necessary to gain handshake latency improvements.  This document describes how that security protocol might be replaced with DTLS.</p>
<h1 id="rfc.status">
  <a href="#rfc.status">Status of This Memo</a>
</h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on July 24, 2016.</p>
<h1 id="rfc.copyrightnotice">
  <a href="#rfc.copyrightnotice">Copyright Notice</a>
</h1>
<p>Copyright (c) 2016 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a></li>
<ul><li>1.1.   <a href="#rfc.section.1.1">Notational Conventions</a></li>
</ul><li>2.   <a href="#rfc.section.2">Protocol Overview</a></li>
<ul><li>2.1.   <a href="#rfc.section.2.1">Handshake Overview</a></li>
</ul><li>3.   <a href="#rfc.section.3">QUIC over DTLS Structure</a></li>
<li>4.   <a href="#rfc.section.4">Mapping of QUIC to QUIC over DTLS</a></li>
<ul><li>4.1.   <a href="#rfc.section.4.1">Handshake Additions</a></li>
<ul><li>4.1.1.   <a href="#rfc.section.4.1.1">Source Address Validation</a></li>
<li>4.1.2.   <a href="#rfc.section.4.1.2">Transport Parameter Advertisement</a></li>
<li>4.1.3.   <a href="#rfc.section.4.1.3">Congestion Management Before Handshake Completion</a></li>
</ul><li>4.2.   <a href="#rfc.section.4.2">Record Protection</a></li>
<li>4.3.   <a href="#rfc.section.4.3">Protocol and Version Negotiation</a></li>
<li>4.4.   <a href="#rfc.section.4.4">Connection ID</a></li>
<li>4.5.   <a href="#rfc.section.4.5">Entropy Bit</a></li>
<li>4.6.   <a href="#rfc.section.4.6">Forward Error Control (FEC)</a></li>
<li>4.7.   <a href="#rfc.section.4.7">Sequence Numbers</a></li>
</ul><li>5.   <a href="#rfc.section.5">Modifications to DTLS</a></li>
<ul><li>5.1.   <a href="#rfc.section.5.1">Handshake Message Loss Recovery</a></li>
<li>5.2.   <a href="#rfc.section.5.2">DTLS Datagram Header</a></li>
</ul><li>6.   <a href="#rfc.section.6">Security Considerations</a></li>
<li>7.   <a href="#rfc.section.7">IANA Considerations</a></li>
<li>8.   <a href="#rfc.references">References</a></li>
<ul><li>8.1.   <a href="#rfc.references.1">Normative References</a></li>
<li>8.2.   <a href="#rfc.references.2">Informative References</a></li>
</ul><li><a href="#rfc.authors">Author's Address</a></li>


  </ul>

  <h1 id="rfc.section.1"><a href="#rfc.section.1">1.</a> <a href="#introduction" id="introduction">Introduction</a></h1>
<p id="rfc.section.1.p.1">QUIC <a href="#I-D.tsvwg-quic-protocol">[I-D.tsvwg-quic-protocol]</a> provides a multiplexed transport for HTTP <a href="#RFC7230">[RFC7230]</a> semantics that provides several key advantages over HTTP/1.1 <a href="#RFC7230">[RFC7230]</a> or HTTP/2 <a href="#RFC7540">[RFC7540]</a> over TCP <a href="#RFC0793">[RFC0793]</a>.</p>
<p id="rfc.section.1.p.2">The custom security protocol designed for QUIC provides critical latency improvements for connection establishment.  Absent packet loss, most new connections can be established with a single round trip; on subsequent connections between the same client and server, the client can often send application data immediately, that is, zero round trip setup.  DTLS 1.3 uses a similar design and aims to provide the same set of improvements.</p>
<p id="rfc.section.1.p.3">This document describes how the standardized DTLS 1.3 might serve as a security layer for QUIC.  The same design could work for DTLS 1.2, though few of the benefits QUIC provides would be realized due to the handshake latency in versions of TLS prior to 1.3.</p>
<p/>

<dl>
  <dt>Alternative Designs:</dt>
  <dd style="margin-left: 8">There are other designs that are possible; and many of these alternative designs are likely to be equally good.  The point of this document is to articulate a coherent single design.  Notes like this throughout the document are used describe points where alternatives were considered.</dd>
</dl>
<h2 id="rfc.section.1.1"><a href="#rfc.section.1.1">1.1.</a> <a href="#notational-conventions" id="notational-conventions">Notational Conventions</a></h2>
<p id="rfc.section.1.1.p.1">The words &#8220;MUST&#8221;, &#8220;MUST NOT&#8221;, &#8220;SHOULD&#8221;, and &#8220;MAY&#8221; are used in this document.  It&#8217;s not shouting; when they are capitalized, they have the special meaning defined in <a href="#RFC2119">[RFC2119]</a>.</p>
<h1 id="rfc.section.2"><a href="#rfc.section.2">2.</a> <a href="#protocol-overview" id="protocol-overview">Protocol Overview</a></h1>
<p id="rfc.section.2.p.1">QUIC <a href="#I-D.tsvwg-quic-protocol">[I-D.tsvwg-quic-protocol]</a> can be separated into several modules:</p>
<p/>

<ol>
  <li>The basic frame envelope describes the common packet layout.  This layer includes connection identification, version negotiation, and includes the indicators that allow the framing, public reset, and FEC modules to be identified.</li>
  <li>The public reset is an unprotected frame that allows an intermediary (an entity that is not part of the security context) to request the termination of a QUIC connection.</li>
  <li>The forward error correction (FEC) module provides redundant entropy that allows for frames to be repaired in event of loss.</li>
  <li>Framing comprises most of the QUIC protocol.  Framing provides a number of different types of frame, each with a specific purpose.  Framing supports frames for both congestion management and stream multiplexing.  Framing additionally provides a liveness testing capability (the PING frame).</li>
  <li>Crypto provides confidentiality and integrity protection for frames.  All frames are protected after the handshake completes on stream 1.</li>
  <li>Multiplexed streams are the primary payload of QUIC.  These provide reliable, in-order delivery of data and are used to carry the encryption handshake (stream 1), HTTP header fields (stream 3), and HTTP requests and responses.  Frames for managing multiplexing include those for creating and destroying streams as well as flow control and priority frames.</li>
  <li>Congestion management includes packet acknowledgment and other signal required to ensure effective use of available link capacity.</li>
  <li>HTTP mapping provides an adaptation to HTTP that is based on HTTP/2.</li>
</ol>
<p id="rfc.section.2.p.3">The relative relationship of these components are pictorally represented in <a href="#quic-structure">Figure 1</a>.</p>
<div id="rfc.figure.1"/>
<div id="quic-structure"/>
<pre>
   +----+------+
   | HS | HTTP |
   +----+------+------------+
   |  Streams  | Congestion |
   +-----------+------------+
   |        Frames          |
   +  +---------------------+
   |  |      FEC            +--------+
   +  +---------------------+ Public |
   |  |     Crypto          | Reset  |
   +--+---------------------+--------+
   |              Envelope           |
   +---------------------------------+
   |                UDP              |
   +---------------------------------+

                             *HS = Crypto Handshake
</pre>
<p class="figure">Figure 1: QUIC Structure</p>
<p id="rfc.section.2.p.4">This document describes a replacement of the cryptographic parts of QUIC.  This includes the handshake messages that are exchanged on stream 1, plus the record protection that is used to encrypt and authenticate all other frames.</p>
<h2 id="rfc.section.2.1"><a href="#rfc.section.2.1">2.1.</a> <a href="#handshake-overview" id="handshake-overview">Handshake Overview</a></h2>
<p id="rfc.section.2.1.p.1">TLS 1.3 provides two basic handshake modes of interest to QUIC:</p>
<p/>

<ul>
  <li>A full handshake in which the client is able to send application data after one round trip and the server immediately after receiving the first message from the client.</li>
  <li>A 0-RTT handshake in which the client uses information about the server to send immediately.  This data can be replayed by an attacker so it MUST NOT carry a self-contained trigger for any non-idempotent action.</li>
</ul>
<p id="rfc.section.2.1.p.3">A simplified TLS 1.3 handshake with 0-RTT application data is shown in <a href="#tls-full">Figure 2</a>, see <a href="#I-D.ietf-tls-tls13">[I-D.ietf-tls-tls13]</a> for more options.</p>
<div id="rfc.figure.2"/>
<div id="tls-full"/>
<pre>
    Client                                             Server

    ClientHello
   (Finished)
   (0-RTT Application Data)
   (end_of_early_data)        --------&gt;
                                                  ServerHello
                                         {EncryptedExtensions}
                                         {ServerConfiguration}
                                                 {Certificate}
                                           {CertificateVerify}
                                                    {Finished}
                             &lt;--------      [Application Data]
   {Finished}                --------&gt;

   [Application Data]        &lt;-------&gt;      [Application Data]
</pre>
<p class="figure">Figure 2: TLS Handshake with 0-RTT</p>
<p id="rfc.section.2.1.p.4">Two additional variations on this basic handshake exchange are relevant to this document:</p>
<p/>

<ul>
  <li>The server can respond to a ClientHello with a HelloRetryRequest, which adds an additional round trip prior to the basic exchange.  This is needed if the server wishes to request a different key exchange key from the client.  HelloRetryRequest might also be used to verify that the client is correctly able to receive packets on the address it claims to have (see <a href="#source-address">Section 4.1.1</a>).</li>
  <li>A pre-shared key mode can be used for subsequent handshakes to avoid public key operations.  (FFS: 0-RTT for PSK seems feasible, but it isn&#8217;t clearly defined right now).</li>
</ul>
<h1 id="rfc.section.3"><a href="#rfc.section.3">3.</a> <a href="#quic-over-dtls-structure" id="quic-over-dtls-structure">QUIC over DTLS Structure</a></h1>
<p id="rfc.section.3.p.1">QUIC completes its cryptographic handshake on stream 1, which means that the negotiation of keying material happens within the QUIC protocol.  In contrast, QUIC over DTLS uses a layered approach, where QUIC frames are exchanged as DTLS application data.</p>
<div id="rfc.figure.3"/>
<div id="dtls-quic-stack"/>
<pre>
   +-----------+
   |   HTTP    |
   +-----------+------------+
   |  Streams  | Congestion |
   +-----------+------------+
   |        Frames          |
   +------------------------+
   |         FEC            +--------+
   +------------------------+ Public |
   |         DTLS           | Reset  |
   +------------------------+--------+
   |                  UDP            |
   +---------------------------------+
</pre>
<p class="figure">Figure 3: QUIC over DTLS</p>
<p id="rfc.section.3.p.2">In this design QUIC frames are exchanged as DTLS application data.  FEC and public reset are provided as minimal protocols that are multiplexed with DTLS, using a different value for the first octet of the UDP payload (see <a href="#packet">Section 5.2</a> for a sample design).</p>
<p id="rfc.section.3.p.3">The DTLS handshake is the first data that is exchanged on a connection, though additional QUIC-specific data might be included, see <a href="#additions">Section 4.1</a>.</p>
<p/>

<dl>
  <dt>Alternative Design:</dt>
  <dd style="margin-left: 8">DTLS could be used as a drop-in replacement for the handshake protocol used by QUIC crypto.  This would require less restructuring of QUIC.  However, that suggests that record protection is ultimately managed by QUIC, negating much of the advantage provided by choosing a layered design.  For instance, improvements are made to DTLS would not be immediately available to QUIC.  A more serious problem here is the synchronization of frames with the traffic keys used to protect them.  Within DTLS, the transition from cleartext to handshake traffic keys and application traffic keys is carefully synchronized with the handshake.  Coordinating multiple key derivations for use in a drop-in design would require careful synchronization.</dd>
</dl>
<h1 id="rfc.section.4"><a href="#rfc.section.4">4.</a> <a href="#mapping-of-quic-to-quic-over-dtls" id="mapping-of-quic-to-quic-over-dtls">Mapping of QUIC to QUIC over DTLS</a></h1>
<p id="rfc.section.4.p.1">Several changes to the structure of QUIC are necessary to make a layered design practical.</p>
<p id="rfc.section.4.p.2">These changes produce the handshake shown in <a href="#quic-dtls-handshake">Figure 4</a>, where QUIC frames are exchanged as DTLS application data.</p>
<div id="rfc.figure.4"/>
<div id="quic-dtls-handshake"/>
<pre>
    Client                                             Server

    ClientHello
     + QUIC Setup Parameters
     + ALPN ("quic")
   (Finished)
   (Replayable QUIC Frames)
   (end_of_early_data)        --------&gt;
                                                  ServerHello
                                         {EncryptedExtensions}
                                         {ServerConfiguration}
                                                 {Certificate}
                                           {CertificateVerify}
                                                    {Finished}
                             &lt;--------           [QUIC Frames]
   {Finished}                --------&gt;

   [QUIC Frames]             &lt;-------&gt;           [QUIC Frames]
</pre>
<p class="figure">Figure 4: QUIC over DTLS Handshake</p>
<p id="rfc.section.4.p.3">The remainder of this section describes how QUIC features are modified to fit into a layered design.</p>
<h2 id="rfc.section.4.1"><a href="#rfc.section.4.1">4.1.</a> <a href="#additions" id="additions">Handshake Additions</a></h2>
<p><a href="#I-D.tsvwg-quic-protocol">[I-D.tsvwg-quic-protocol]</a> does not describe any connection-level state that might be included by a client in a standard 1-RTT handshake to aid in connection setup.  However, the following additions are either implemented, or might be.</p>
<h3 id="rfc.section.4.1.1"><a href="#rfc.section.4.1.1">4.1.1.</a> <a href="#source-address" id="source-address">Source Address Validation</a></h3>
<p id="rfc.section.4.1.1.p.1">QUIC implementations describe a source address token.  This is an opaque blob that a server provides to clients when they first use a given source address.  The client returns this token in subsequent messages as a return routeability check.  That is, the client returns this token to prove that it is able to receive packets at the source address that it claims.</p>
<p id="rfc.section.4.1.1.p.2">Since this token is opaque and consumed only by the server, it can be included in the TLS 1.3 configuration identifier for 0-RTT handshakes.  Servers that use 0-RTT are advised to provide new configuration identifiers after every handshake to avoid passive linkability of connections from the same client.</p>
<p id="rfc.section.4.1.1.p.3">A server that is under load might include the same information in the cookie extension/field of a HelloRetryRequest. (Note: the current version of TLS 1.3 does not include this information.)</p>
<h3 id="rfc.section.4.1.2"><a href="#rfc.section.4.1.2">4.1.2.</a> <a href="#transport-parameter-advertisement" id="transport-parameter-advertisement">Transport Parameter Advertisement</a></h3>
<p id="rfc.section.4.1.2.p.1">A client describes characteristics of the transport protocol it intends to conduct with the server in a new <samp>quic_transport_parameters</samp> extension in its ClientHello.  The server uses this information to determine whether it wants to continue the connection, request source address validation, or reject the connection.  Having this information unencrypted permits this check to occur prior to committing the resources needed to complete the initial key exchange.</p>
<p id="rfc.section.4.1.2.p.2">If the server decides to complete the connection, it generates a corresponding response and includes it in the EncryptedExtensions message.</p>
<p id="rfc.section.4.1.2.p.3">These parameters are not confidentiality-protected when sent by the client, but the server response is protected by the handshake traffic keys.  The entire exchange is integrity protected once the handshake completes.</p>
<p id="rfc.section.4.1.2.p.4">This information is not used by DTLS, but passed to the QUIC protocol as initialization parmeters.</p>
<h3 id="rfc.section.4.1.3"><a href="#rfc.section.4.1.3">4.1.3.</a> <a href="#congestion-management-before-handshake-completion" id="congestion-management-before-handshake-completion">Congestion Management Before Handshake Completion</a></h3>
<p id="rfc.section.4.1.3.p.1">In addition to the parameters for the transport, congestion feedback might need be exchanged prior to completing a key exchange is complete.</p>
<p id="rfc.section.4.1.3.p.2">A new QUIC congestion extension might be included by clients to include any information.  Servers might include this extension if there is a need to use the HelloRetryRequest also.  Once the handshake is complete, this information can be exchanged as QUIC frames.</p>
<p id="rfc.section.4.1.3.p.3">The use of extensions for the purpose has some potential drawbacks:</p>
<p/>

<ul>
  <li>Extensions are vulnerable to modification prior to the successful completion of the handshake.  (The key schedule is structured so that the handshake encryption keys will likely differ if extensions are modified, though this is not a strong guarantee.)</li>
  <li>Extensions are authenticated, and therefore cannot contain updated information if they need to be retransmitted.</li>
  <li>Extensions that appear prior to the EncryptedExtensions do not have any confidentiality protection.</li>
</ul>
<p><a href="#dtls-feedback">Section 5.1</a> identifies the related issue of loss feedback mechanisms during the handshaking phase.</p>
<h2 id="rfc.section.4.2"><a href="#rfc.section.4.2">4.2.</a> <a href="#record-protection" id="record-protection">Record Protection</a></h2>
<p id="rfc.section.4.2.p.1">No changes are required to transport frames as DTLS application data.</p>
<h2 id="rfc.section.4.3"><a href="#rfc.section.4.3">4.3.</a> <a href="#protocol-and-version-negotiation" id="protocol-and-version-negotiation">Protocol and Version Negotiation</a></h2>
<p id="rfc.section.4.3.p.1">Application Layer Protocol Negotiation (ALPN) <a href="#RFC7301">[RFC7301]</a> will be used to negotiate the version of QUIC that is used.  This is a more verbose mechanism than the scheme used in QUIC, but it is also more capable. For example, specific QUIC versions could be separately identified: &#8220;quic-draft-01&#8221;, &#8220;quic-draft-02&#8221;, and &#8220;quic-underdamped-cc&#8221;.</p>
<h2 id="rfc.section.4.4"><a href="#rfc.section.4.4">4.4.</a> <a href="#connection-id" id="connection-id">Connection ID</a></h2>
<p id="rfc.section.4.4.p.1">The connection identifier serves to identify a connection and to allow a server to resume an existing connection from a new client address in case of mobility events.</p>
<p id="rfc.section.4.4.p.2">TLS 1.3 offers connection resumption using pre-shared keys, which might permit a client to send 0-RTT application data (Note: this is an open issue in TLS).  This mode could be used to continue a connection rather than rely on a publicly visible correlator.</p>
<p id="rfc.section.4.4.p.3">Alternatively, clients could use a new 0-RTT handshake to continue existing connections.</p>
<h2 id="rfc.section.4.5"><a href="#rfc.section.4.5">4.5.</a> <a href="#entropy-bit" id="entropy-bit">Entropy Bit</a></h2>
<p id="rfc.section.4.5.p.1">This can be removed, and is (apparently) already have been removed from current implementations.</p>
<h2 id="rfc.section.4.6"><a href="#rfc.section.4.6">4.6.</a> <a href="#forward-error-control-fec" id="forward-error-control-fec">Forward Error Control (FEC)</a></h2>
<p id="rfc.section.4.6.p.1">FEC can be covered by encryption and forms part of the framing layer.  The current protocol has some external parts, but these can be encrypted.</p>
<h2 id="rfc.section.4.7"><a href="#rfc.section.4.7">4.7.</a> <a href="#sequence-numbers" id="sequence-numbers">Sequence Numbers</a></h2>
<p id="rfc.section.4.7.p.1">QUIC relies on a single sequence number space for identifying frames.  DTLS does not provide a contiguous sequence number space as each change of traffic keys causes sequence numbers to be reset.  This change occurs at the transition from 0-RTT application data to full application data, plus when traffic keys are updated.</p>
<p id="rfc.section.4.7.p.2">DTLS sequence numbers could be used in QUIC acknowledgments, but some modification would be needed to allow for the epoch change and sequence number resets.</p>
<p id="rfc.section.4.7.p.3">A possible design has separate acknowledgment frames for different epochs.  Reserving a small number of bits (a little as 1 or 2 bits would suffice) for identifying the epoch in longer sequence number representations would allow each acknowledgment frame be limited to that epoch.  Shorter representations might omit the epoch bits so that normal operation can identify a wider range of packets without inflating packet size inordinately.</p>
<p id="rfc.section.4.7.p.4">The consequence of this design is that there will be multiple acknowledgment frames sent for a short period after an epoch change.  A modification to QUIC&#8217;s STOP_WAITING frame might be used to quickly end any need for acknowledgment on the expired epoch.</p>
<p/>

<dl>
  <dt>Editor&#8217;s Note:</dt>
  <dd style="margin-left: 8">The design of STOP_WAITING relies on the sequence number of the packet that it is contained in.  That design doesn&#8217;t work in this case.  Adding a single octet that included the affected epoch would also allow the packet to be self-contained and include a the sequence number length.</dd>
</dl>
<p id="rfc.section.4.7.p.6">There is no need to explicitly signal the sequence number of the last packet in an epoch.  The last sequence number for the epoch will be included in an acknowledgment.</p>
<p/>

<dl>
  <dt>Alternative Design:</dt>
  <dd style="margin-left: 8">A separate sequence number space could be added to the DTLS-protected QUIC frames, inside the protected DTLS record.  This is potentially redundant, but it ensures that QUIC is more independent of DTLS.</dd>
</dl>
<h1 id="rfc.section.5"><a href="#rfc.section.5">5.</a> <a href="#modifications-to-dtls" id="modifications-to-dtls">Modifications to DTLS</a></h1>
<p id="rfc.section.5.p.1">DTLS 1.3 does not need substantial modifications in order to support the more critical features of QUIC.  However, some additional changes might be made to optimize DTLS for use with QUIC.</p>
<p id="rfc.section.5.p.2">Since the work on TLS 1.3 is not yet complete, these changes might be integrated before TLS 1.3 is completed.  Failing that, new extensions to TLS might be considered to negotiate their use.</p>
<h2 id="rfc.section.5.1"><a href="#rfc.section.5.1">5.1.</a> <a href="#dtls-feedback" id="dtls-feedback">Handshake Message Loss Recovery</a></h2>
<p id="rfc.section.5.1.p.1">DTLS has a somewhat simplistic retransmission scheme for its handshake datagrams.  An entire flight of handshake messages is sent repeatedly by an endpoint until it receives a response from its peer.  In this regard, the QUIC scheme of acknowledgments is more precise in identifying and repairing missing datagrams.  Providing a more complete and accurate feedback mechanism would be valuable in reducing the performance of the handshake.</p>
<h2 id="rfc.section.5.2"><a href="#rfc.section.5.2">5.2.</a> <a href="#packet" id="packet">DTLS Datagram Header</a></h2>
<p id="rfc.section.5.2.p.1">DTLS 1.2 <a href="#RFC6347">[RFC6347]</a> has a rather large per-packet overhead.  This overhead includes a content type (1 octet), protocol version (2 octets), an epoch (2 octets), sequence number (6 octets) and length (2 octets), totalling 13 octets on every record.  Of these, only the sequence number and 14 bits of the record length are critical to the correct functioning of the protocol and both might be reduced in size.  A single bit of the epoch is useful in allowing an endpoint to more easily identify when keys change.</p>
<p id="rfc.section.5.2.p.2">Note that a change to the packet format needs to be carefully designed if DTLS is to remain compatible with existing use cases.  DTLS-SRTP <a href="#RFC5764">[RFC5764]</a> relies on the value of the first octet of the DTLS packet not overlapping with valid values for SRTP <a href="#RFC3711">[RFC3711]</a> and STUN <a href="#RFC5389">[RFC5389]</a>.  Only values 20 through 63 inclusive are guaranteed to be available to DTLS in that context.</p>
<p id="rfc.section.5.2.p.3">One possible design has a four octet header, comprising three fixed bits (001), 1 epoch bit, 12 sequence number bits, 2 zero bits, and 14 length bits.  This format would only apply to encrypted datagrams, since the ClientHello and ServerHello would need to be backward compatible.</p>
<div id="rfc.figure.5"/>
<div id="packet-header"/>
<pre>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|0 0 1|e|sequence number (13bit)|0 0|   length (14bit)          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<p class="figure">Figure 5: Packet Header</p>
<p id="rfc.section.5.2.p.4">Note that the second set of zero bits could be used for an expanded sequence number space.  However, if there is any expectation of being able to use datagrams that are more than 4096 packets out of sequence, then adding another octet might be a better option, even if that results in destroying word alignment.</p>
<p id="rfc.section.5.2.p.5">This design allows for unprotected messages such as unprotected handshake messages and the QUIC public reset to use values between 20 and 31 in the first octet.  If FEC is used to repair protected packets (a detail that <a href="#I-D.tsvwg-quic-protocol">[I-D.tsvwg-quic-protocol]</a> is unclear on), then FEC packets can use a first octet in this range as well.</p>
<p/>

<dl>
  <dt>Alternative Design:</dt>
  <dd style="margin-left: 8">If a UDP datagram is restricted to containing a single DTLS record, the length field could be omitted entirely, reducing the unencrypted overhead to as little as 2 octets.  The drawback of this approach is that it could require some additional UDP datagrams during the handshake, since changes to keying material can only happen when a new record is sent.</dd>
</dl>
<h1 id="rfc.section.6"><a href="#rfc.section.6">6.</a> <a href="#security-considerations" id="security-considerations">Security Considerations</a></h1>
<p id="rfc.section.6.p.1">Including data outside of the DTLS protection layer exposes endpoints to all sorts of intermediary-initiated shenanigans.</p>
<h1 id="rfc.section.7"><a href="#rfc.section.7">7.</a> <a href="#iana-considerations" id="iana-considerations">IANA Considerations</a></h1>
<p id="rfc.section.7.p.1">This document has no IANA actions.</p>
<h1 id="rfc.references"><a href="#rfc.references">8.</a> References</h1>
<h2 id="rfc.references.1"><a href="#rfc.references.1">8.1.</a> Normative References</h2>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="I-D.ietf-tls-tls13">[I-D.ietf-tls-tls13]</b>
      </td>
      <td class="top"><a>Rescorla, E.</a>, "<a href="http://tools.ietf.org/html/draft-ietf-tls-tls13-11">The Transport Layer Security (TLS) Protocol Version 1.3</a>", Internet-Draft draft-ietf-tls-tls13-11, December 2015.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="I-D.tsvwg-quic-protocol">[I-D.tsvwg-quic-protocol]</b>
      </td>
      <td class="top"><a>Iyengar, J.</a> and <a>I. Swett</a>, "<a href="http://tools.ietf.org/html/draft-tsvwg-quic-protocol-01">QUIC: A UDP-Based Secure and Reliable Transport for HTTP/2</a>", Internet-Draft draft-tsvwg-quic-protocol-01, July 2015.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC2119">[RFC2119]</b>
      </td>
      <td class="top"><a>Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, DOI 10.17487/RFC2119, March 1997.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7301">[RFC7301]</b>
      </td>
      <td class="top"><a>Friedl, S.</a>, <a>Popov, A.</a>, <a>Langley, A.</a> and <a>E. Stephan</a>, "<a href="http://tools.ietf.org/html/rfc7301">Transport Layer Security (TLS) Application-Layer Protocol Negotiation Extension</a>", RFC 7301, DOI 10.17487/RFC7301, July 2014.</td>
    </tr>
  </tbody>
</table>
<h2 id="rfc.references.2"><a href="#rfc.references.2">8.2.</a> Informative References</h2>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="RFC0793">[RFC0793]</b>
      </td>
      <td class="top"><a>Postel, J.</a>, "<a href="http://tools.ietf.org/html/rfc793">Transmission Control Protocol</a>", STD 7, RFC 793, DOI 10.17487/RFC0793, September 1981.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC3711">[RFC3711]</b>
      </td>
      <td class="top"><a>Baugher, M.</a>, <a>McGrew, D.</a>, <a>Naslund, M.</a>, <a>Carrara, E.</a> and <a>K. Norrman</a>, "<a href="http://tools.ietf.org/html/rfc3711">The Secure Real-time Transport Protocol (SRTP)</a>", RFC 3711, DOI 10.17487/RFC3711, March 2004.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5389">[RFC5389]</b>
      </td>
      <td class="top"><a>Rosenberg, J.</a>, <a>Mahy, R.</a>, <a>Matthews, P.</a> and <a>D. Wing</a>, "<a href="http://tools.ietf.org/html/rfc5389">Session Traversal Utilities for NAT (STUN)</a>", RFC 5389, DOI 10.17487/RFC5389, October 2008.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5764">[RFC5764]</b>
      </td>
      <td class="top"><a>McGrew, D.</a> and <a>E. Rescorla</a>, "<a href="http://tools.ietf.org/html/rfc5764">Datagram Transport Layer Security (DTLS) Extension to Establish Keys for the Secure Real-time Transport Protocol (SRTP)</a>", RFC 5764, DOI 10.17487/RFC5764, May 2010.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC6347">[RFC6347]</b>
      </td>
      <td class="top"><a>Rescorla, E.</a> and <a>N. Modadugu</a>, "<a href="http://tools.ietf.org/html/rfc6347">Datagram Transport Layer Security Version 1.2</a>", RFC 6347, DOI 10.17487/RFC6347, January 2012.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7230">[RFC7230]</b>
      </td>
      <td class="top"><a>Fielding, R.</a> and <a>J. Reschke</a>, "<a href="http://tools.ietf.org/html/rfc7230">Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing</a>", RFC 7230, DOI 10.17487/RFC7230, June 2014.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7540">[RFC7540]</b>
      </td>
      <td class="top"><a>Belshe, M.</a>, <a>Peon, R.</a> and <a>M. Thomson</a>, "<a href="http://tools.ietf.org/html/rfc7540">Hypertext Transfer Protocol Version 2 (HTTP/2)</a>", RFC 7540, DOI 10.17487/RFC7540, May 2015.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.authors">
  <a href="#rfc.authors">Author's Address</a>
</h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Martin Thomson</span> 
	  <span class="n hidden">
		<span class="family-name">Thomson</span>
	  </span>
	</span>
	<span class="org vcardline">Mozilla</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:martin.thomson@gmail.com">martin.thomson@gmail.com</a></span>

  </address>
</div>

  <div class="github-fork-ribbon-wrapper"><div class="github-fork-ribbon"><a href="https://github.com/martinthomson/quic-dtls">Fork me on GitHub</a></div></div>
</body>
</html>
